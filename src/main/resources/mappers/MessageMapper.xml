<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cc.nekocc.cyanchatroom.model.mapper.MessageMapper">

    <insert id="insertMessage" parameterType="Message">
        INSERT INTO messages (id, conversation_id, type, content, created_at)
        VALUES (#{uuid_}, #{conversation_id_}, #{type_}, #{val_}, #{time_})
    </insert>

    <insert id="insertMessagesBatch" parameterType="java.util.List">
        INSERT INTO messages (id, conversation_id, type, content, created_at)
        VALUES
        <foreach collection="messages" item="msg" separator=",">
            (#{msg.uuid_}, #{msg.conversation_id_}, #{msg.type_}, #{msg.val_}, #{msg.time_})
        </foreach>
    </insert>

    <select id="findAllMessagesByConversationId" parameterType="string" resultType="Message">
        SELECT
        id as uuid_,
        conversation_id as conversation_id_,
        type as type_,
        content as val_,
        created_at as time_
        FROM messages
        WHERE conversation_id = #{conversation_id}
        ORDER BY created_at ASC
    </select>

    <select id="findMessagesByRange" resultType="Message">
        SELECT
        id as uuid_,
        conversation_id as conversation_id_,
        type as type_,
        content as val_,
        created_at as time_
        FROM messages
        WHERE conversation_id = #{conversation_id}
        ORDER BY created_at DESC
        LIMIT #{limit} OFFSET #{offset}
    </select>

    <select id="countMessagesInConversation" parameterType="string" resultType="int">
        SELECT COUNT(*) FROM messages WHERE conversation_id = #{conversation_id}
    </select>

    <delete id="deleteOldestMessages">
        DELETE FROM messages
        WHERE id IN (
        SELECT id FROM messages
        WHERE conversation_id = #{conversation_id}
        ORDER BY created_at ASC
        LIMIT #{count}
        )
    </delete>

</mapper>
